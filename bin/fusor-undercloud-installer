#!/bin/bash

# create stack user, become her
useradd stack
echo "stack ALL=(root) NOPASSWD:ALL" >> /etc/sudoers.d/stack
chmod 0440 /etc/sudoers.d/stack

sudo -u stack mkdir -p /home/stack/images
sudo -u stack mkdir -p /home/stack/templates

# Create a stupid bogus yum repo so that yum won't exit with an error status
# during the undercloud install
mkdir /tmp/repodata

echo '<metadata packages="2"><package type="rpm"><name>mysql-libs</name><arch>x86_64</arch><version epoch="0" ver="5.4" rel="1"/><checksum type="sha" pkgid="YES">94099f245daf064eebd591023af87c891eaaa291</checksum><summary>Fake package to make yum dependency resolution work</summary></package><package type="rpm"><name>mysql-devel</name><arch>x86_64</arch><version epoch="0" ver="5.4" rel="1"/><checksum type="sha" pkgid="YES">94099f245daf064eebd591023af87c891eaaa291</checksum><summary>Fake package to make yum dependency resolution work</summary></package></metadata>' > /tmp/repodata/primary.xml

echo '<filelists packages="2"><package name="mysql-libs" arch="x86_64"><version epoch="0" ver="5.4" rel="1"/></package><package name="mysql-devel" arch="x86_64"><version epoch="0" ver="5.4" rel="1"/></package></filelists>' > /tmp/repodata/filelists.xml

echo '<repomd><revision>1</revision><data type="primary"><checksum type="sha">7a221b9483a86c65378d744ca9f075b7afd25a03</checksum><location href="repodata/primary.xml"/></data><data type="filelists"><checksum type="sha">66fc42e40a9504c889b9b217f71e0a02abb1f454</checksum><location href="repodata/filelists.xml"/></data></repomd>' > /tmp/repodata/repomd.xml

echo "[fake-repo-to-make-yum-happy]
name=fake-repo-to-make-yum-happy
baseurl=file:///tmp
enabled=1" > /etc/yum.repos.d/fake.repo

# Exit if this stuff doesn't go right
set -e

# enable IP forwarding
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
sysctl -p /etc/sysctl.conf

# do the hostname into hosts
read -e -p "Set your resolvable Fully Qualified Domain Name: " -i $HOSTNAME HOSTNAME
hostnamectl set-hostname $HOSTNAME
hostnamectl set-hostname --transient $HOSTNAME
# In case we're running this installer again, delete any previous entries
sed -i '/fusor-undercloud-installer/,+1d' /etc/hosts
echo "# fusor-undercloud-installer managed:" >> /etc/hosts
echo "127.0.0.1 $HOSTNAME `hostname -s`" >> /etc/hosts

# Ask for DNS server and set it if not already in resolv.conf
NAMESERVER=`grep nameserver /etc/resolv.conf | awk '{print $2}'`
if [ -z $NAMESERVER ]; then NAMESERVER='127.0.0.1'; fi
read -e -p "Enter the DNS nameserver to use for the Overcloud: " -i $NAMESERVER NAMESERVER
grep -q $NAMESERVER /etc/resolv.conf || echo "nameserver $NAMESERVER" >> /etc/resolv.conf

# Store public ip address for later
# If there's an error, the next call to configurator will print it
# let's not exit this script here because the error will not be printed
set +e
MYADDR=`fusor-undercloud-configurator get-addr`
set -e

# Prompt user for network setup and write the undercloud config file
sudo -u stack fusor-undercloud-configurator

# call out to egon to run the undercloud installer
cd /home/stack
sudo -u stack scl enable ruby193 "undercloud-install-local.rb" # call egon to do the install

# Delete the stupid bogus repo
rm -rf /tmp/repodata
rm -f /etc/yum.repos.d/fake.repo

# untar the overcloud images
echo "Importing Overcloud images."
cd /home/stack/images
for a in `ls -1 /root/images/*.tar`; do
  tar -xf $a
done
chown stack:stack /home/stack/images/*

# Upload the overcloud images
cd /home/stack/images
source /home/stack/stackrc
openstack overcloud image upload

# Set DNS server
NETWORK_ID=`neutron subnet-list | grep start | awk '{print $2}'`
neutron subnet-update $NETWORK_ID --dns-nameserver $NAMESERVER

# Echo out ip addr and password
echo "Installation complete!"
echo
echo "Your IP Address is:"
echo $MYADDR
echo "Make a note of this for the RHCI web UI."
